<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¶£å‘³æ€ç»´å¯¼å›¾</title>
  <!-- å¼•å…¥vis-networkåº“ -->
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    /* å¼•å…¥Comic Neueå­—ä½“ */
    @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap');

    /* åŸºç¡€æ ·å¼è®¾ç½® */
    body,
    html {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Comic Neue', cursive;
      background-color: #FFF5E6;
      position: relative;
    }

    /* æ€ç»´å¯¼å›¾å®¹å™¨æ ·å¼ */
    #mindmap {
      width: 100%;
      height: 100%;
      background-color: #FFF5E6;
      /* åˆ›å»ºç‚¹çŠ¶èƒŒæ™¯ */
      background-image:
              radial-gradient(#FFD699 2px, transparent 2px),
              radial-gradient(#FFB366 2px, transparent 2px);
      background-size: 40px 40px;
      background-position: 0 0, 20px 20px;
    }

    /* æ“ä½œè¯´æ˜æ‚¬æµ®å®¹å™¨æ ·å¼ */
    #operation-container {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
      border: 2px solid #FF9933;
      overflow: auto;
      max-width: 90%;
      max-height: 90%;
      z-index: 1000;
      box-sizing: border-box;
      resize: none;
    }

    /* æ³¨é‡Šé¢æ¿æ‚¬æµ®å®¹å™¨æ ·å¼ */
    #annotation-container {
      position: absolute;
      top: 20px;
      left: 20px; /* ä¸æ“ä½œè¯´æ˜é¢æ¿ç›¸åŒä½ç½® */
      background-color: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
      border: 2px solid #FF9933;
      overflow: auto;
      max-width: 90%;
      max-height: 90%;
      z-index: 1000;
      box-sizing: border-box;
      resize: none;
      display: none; /* åˆå§‹éšè— */
      right: 20px;
      left: auto;
    }

    /* å…³é—­æŒ‰é’®æ ·å¼ */
    #close-operation,
    #close-annotation {
      position: absolute;
      top: 5px;
      right: 10px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #8B4513;
    }

    /* å±•å¼€æ“ä½œè¯´æ˜æŒ‰é’®æ ·å¼ */
    #show-operation-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: #FF9933;
      border: none;
      border-radius: 5px;
      padding: 8px 12px;
      font-size: 14px;
      color: #FFFFFF;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 1000;
    }

    /* æ“ä½œè¯´æ˜é¡¹ç›®æ ·å¼ */
    .instruction-item {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }

    /* æ“ä½œå›¾æ ‡æ ·å¼ */
    .instruction-icon {
      display: inline-block;
      width: 30px;
      height: 30px;
      text-align: center;
      line-height: 30px;
      border-radius: 50%;
      margin-right: 10px;
      font-size: 18px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    /* ä¸åŒæ“ä½œçš„å›¾æ ‡é¢œè‰² */
    .add-node-icon {
      background-color: #98FB98;
      color: #006400;
    }

    .add-child-icon {
      background-color: #87CEFA;
      color: #00008B;
    }

    .edit-node-icon {
      background-color: #FFA07A;
      color: #8B0000;
    }

    .delete-node-icon {
      background-color: #FFCC99;
      color: #8B4513;
    }

    .undo-icon {
      background-color: #D3D3D3;
      color: #000000;
    }

    .redo-icon {
      background-color: #D3D3D3;
      color: #000000;
    }

    .annotation-icon {
      background-color: #FFD700;
      color: #8B4513;
    }

    /* æ“ä½œæŒ‰é’®æ ·å¼ */
    .operation-button {
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    /* æ¦‚è§ˆæŒ‰é’®æ ·å¼ */
    #overview-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #FF9933;
      border: none;
      outline: none;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    /* æ¦‚è§ˆæŒ‰é’®æ‚¬åœå’Œç‚¹å‡»æ•ˆæœ */
    #overview-button:hover {
      transform: scale(1.1);
    }

    #overview-button:active {
      transform: scale(0.9);
    }

    /* æ¦‚è§ˆæŒ‰é’®å›¾æ ‡æ ·å¼ */
    #overview-button svg {
      width: 30px;
      height: 30px;
      fill: #8B4513;
    }

    /* æ–°èŠ‚ç‚¹å¼¹å‡ºåŠ¨ç”» */
    @keyframes bounceIn {
      0% {
        transform: scale(0.1);
        opacity: 0;
      }

      60% {
        transform: scale(1.2);
        opacity: 1;
      }

      100% {
        transform: scale(1);
      }
    }

    .new-node {
      animation: bounceIn 0.6s;
    }

    /* æ»šåŠ¨æ¡æ ·å¼ä¼˜åŒ– */
    #operation-container::-webkit-scrollbar,
    #annotation-container::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    #operation-container::-webkit-scrollbar-thumb,
    #annotation-container::-webkit-scrollbar-thumb {
      background-color: #FF9933;
      border-radius: 4px;
    }

    #operation-container::-webkit-scrollbar-track,
    #annotation-container::-webkit-scrollbar-track {
      background-color: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    /* Resize Handle æ ·å¼ */
    .resize-handle {
      position: absolute;
      width: 15px;
      height: 15px;
      background-color: #FF9933;
      border: 2px solid #8B4513;
      border-radius: 50%;
      cursor: se-resize;
      z-index: 1001;
      display: none; /* åˆå§‹éšè— */
    }

    /* å›¾ç‰‡å®¹å™¨æ ·å¼ */
    .image-container {
      position: relative;
      width: 100%;
      height: 100%;
      resize: both;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: contain; /* ä¿æŒç­‰æ¯”ä¾‹é€‚åº” */
    }

    /* æ³¨é‡Šé¢æ¿æ ·å¼ */
    #annotation-container h3 {
      margin-top: 0;
      font-size: 20px;
      color: #8B4513;
    }
  </style>
</head>

<body>
<!-- æ“ä½œè¯´æ˜æ‚¬æµ®å®¹å™¨ -->
<div id="operation-container" style="display: none;">
  <!-- å…³é—­æŒ‰é’® -->
  <button id="close-operation" title="å…³é—­æ“ä½œè¯´æ˜">&times;</button>
  <div class="operation-instructions">
    <div class="instruction-item">
      <span class="instruction-icon add-node-icon">+</span>
      <span>Enter: æ·»åŠ åŒçº§èŠ‚ç‚¹</span>
    </div>
    <div class="instruction-item">
      <span class="instruction-icon add-child-icon">â‡¥</span>
      <span>Tab: æ·»åŠ å­èŠ‚ç‚¹</span>
    </div>
    <div class="instruction-item">
      <span class="instruction-icon edit-node-icon">âœ</span>
      <span>Double left-click: ç¼–è¾‘èŠ‚ç‚¹</span>
    </div>
    <div class="instruction-item">
      <span class="instruction-icon delete-node-icon">âœ–</span>
      <span>Delete/Backspace: åˆ é™¤èŠ‚ç‚¹</span>
    </div>
    <div class="instruction-item operation-button" id="undo-button" title="æ’¤é”€">
      <span class="instruction-icon undo-icon">â†¶</span>
      <span style="margin-left: 10px;">Ctrl+Z: æ’¤é”€</span>
    </div>
    <div class="instruction-item operation-button" id="redo-button" title="é‡åš">
      <span class="instruction-icon redo-icon">â†·</span>
      <span style="margin-left: 10px;">Ctrl+Y: é‡åš</span>
    </div>
    <div class="instruction-item operation-button" id="add-annotation-button" title="æ·»åŠ æ³¨é‡Š">
      <span class="instruction-icon annotation-icon">ğŸ”–</span>
      <span style="margin-left: 10px;">Ctrl+X: æ·»åŠ /ç¼–è¾‘æ³¨é‡Š</span>
    </div>
  </div>
</div>

<!-- æ³¨é‡Šé¢æ¿æ‚¬æµ®å®¹å™¨ -->
<div id="annotation-container">
  <!-- å…³é—­æŒ‰é’® -->
  <button id="close-annotation" title="å…³é—­æ³¨é‡Š">&times;</button>
  <h3>èŠ‚ç‚¹æ³¨é‡Š</h3>
  <div id="annotation-content" style="white-space: pre-wrap;"></div>
</div>

<!-- å±•å¼€æ“ä½œè¯´æ˜æŒ‰é’® -->
<button id="show-operation-button" style="display: block;" title="æ˜¾ç¤ºæ“ä½œè¯´æ˜">æ˜¾ç¤ºæ“ä½œè¯´æ˜</button>

<!-- æ€ç»´å¯¼å›¾å®¹å™¨ -->
<div id="mindmap"></div>

<!-- æ¦‚è§ˆæŒ‰é’® -->
<button id="overview-button" title="é‡æ–°è°ƒæ•´è§†å›¾">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path
            d="M15 3l2.3 2.3-2.89 2.87 1.42 1.42L18.7 6.7 21 9V3h-6zM3 9l2.3-2.3 2.87 2.89 1.42-1.42L6.7 5.3 9 3H3v6zm6 12l-2.3-2.3 2.89-2.87-1.42-1.42L5.3 17.3 3 15v6h6zm12-6l-2.3 2.3-2.87-2.89-1.42 1.42 2.89 2.87L15 21h6v-6z" />
  </svg>
</button>

<!-- Resize Handle -->
<div id="resize-handle" class="resize-handle"></div>

<!-- ä¸»è„šæœ¬ -->
<script>
  // å£°æ˜å…¨å±€å˜é‡
  var operationContainer = document.getElementById('operation-container');
  var annotationContainer = document.getElementById('annotation-container');
  var closeOperationButton = document.getElementById('close-operation');
  var closeAnnotationButton = document.getElementById('close-annotation');
  var showOperationButton = document.getElementById('show-operation-button');
  var overviewButton = document.getElementById('overview-button');
  var undoButton = document.getElementById('undo-button');
  var redoButton = document.getElementById('redo-button');
  var addAnnotationButton = document.getElementById('add-annotation-button');
  var resizeHandle = document.getElementById('resize-handle');
  var annotationContent = document.getElementById('annotation-content');

  // æ§åˆ¶æœ€åè¢«ç¼–è¾‘èŠ‚ç‚¹çš„ID
  var lastModifiedNodeId = null;

  // æ§åˆ¶æ˜¯å¦æ­£åœ¨ç¼–è¾‘èŠ‚ç‚¹
  var isEditingNode = false;

  // æ§åˆ¶æ˜¯å¦æ­£åœ¨æ‰§è¡Œæ’¤é”€/é‡åš
  var isExecutingUndoRedo = false;

  // å…³é—­æ“ä½œè¯´æ˜å®¹å™¨
  closeOperationButton.addEventListener('click', () => {
    operationContainer.style.display = 'none';
    showOperationButton.style.display = 'block';
  });

  // å…³é—­æ³¨é‡Šé¢æ¿
  closeAnnotationButton.addEventListener('click', () => {
    annotationContainer.style.display = 'none';
  });

  // å±•å¼€æ“ä½œè¯´æ˜å®¹å™¨
  showOperationButton.addEventListener('click', () => {
    operationContainer.style.display = 'block';
    showOperationButton.style.display = 'none';
  });

  // åˆå§‹åŒ–èŠ‚ç‚¹æ•°æ®
  var nodes = new vis.DataSet([
    {
      id: 1,
      label: 'ä¸»é¢˜',
      baseLabel: 'ä¸»é¢˜',
      shape: 'box',
      font: { multi: true },
      fixed: { x: true, y: true },
      size: 30 // è®¾ç½®èŠ‚ç‚¹åˆå§‹å¤§å°
    }
  ]);

  // åˆå§‹åŒ–è¾¹æ•°æ®
  var edges = new vis.DataSet([]);

  // è·å–æ€ç»´å¯¼å›¾å®¹å™¨
  var container = document.getElementById('mindmap');
  var data = { nodes: nodes, edges: edges };

  // é…ç½®ç½‘ç»œå›¾é€‰é¡¹
  var options = {
    layout: { hierarchical: false },
    nodes: {
      shape: 'box',
      widthConstraint: { minimum: 100, maximum: 250 },
      font: { size: 20, multi: true, face: 'Comic Neue' },
      borderWidth: 3,
      shadow: true,
      color: {
        border: '#FF9933',
        background: '#FFFACD',
        highlight: { border: '#FF8000', background: '#FFE699' },
        hover: { border: '#FF8000', background: '#FFE699' }
      },
      shapeProperties: {
        borderRadius: 10
      },
      fixed: { x: true, y: true }
    },
    edges: {
      arrows: 'to',
      width: 3,
      color: '#FF9933',
      smooth: { type: 'cubicBezier', forceDirection: 'horizontal', roundness: 0.5 }
    },
    physics: { enabled: false },
    interaction: {
      dragNodes: true,
      dragView: true,
      zoomView: true,
      hover: true,
      selectable: true,
      selectConnectedEdges: false,
      multiselect: false,
      tooltipDelay: 300,
      hideEdgesOnDrag: false,
      hideNodesOnDrag: false
    },
    manipulation: { enabled: false }
  };

  // åˆ›å»ºç½‘ç»œå›¾å®ä¾‹
  var network = new vis.Network(container, data, options);

  // æ¦‚è§ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
  overviewButton.addEventListener('click', () => {
    network.fit({
      animation: {
        duration: 1000,
        easingFunction: 'easeInOutQuad'
      }
    });
  });

  // é”®ç›˜å¿«æ·é”®äº‹ä»¶å¤„ç†
  document.addEventListener('keydown', function (event) {
    const tag = event.target.tagName;
    if (isEditingNode || tag === 'INPUT' || tag === 'TEXTAREA') {
      return;
    }
    const selectedNodes = network.getSelectedNodes();
    if (selectedNodes.length === 1) {
      const selectedNode = selectedNodes[0];
      const node = nodes.get(selectedNode);
      if (!node) return; // é˜²æ­¢nodeä¸ºnull
      // æ£€æŸ¥æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹ï¼ˆå‡è®¾æ ¹èŠ‚ç‚¹IDä¸º1ï¼‰
      const isRootNode = node.id === 1 || edges.get().filter(edge => edge.to === node.id).length === 0;
      if (event.key === 'Enter') {
        // æ·»åŠ åŒçº§èŠ‚ç‚¹
        event.preventDefault();
        const connectedEdges = network.getConnectedEdges(selectedNode);
        const parentEdge = edges.get(connectedEdges).find(edge => edge.to === selectedNode);
        const newNodeId = getNextNodeId();
        addNodeWithAnimation(newNodeId, `æ–°èŠ‚ç‚¹${newNodeId}`, parentEdge ? parentEdge.from : selectedNode);
        network.selectNodes([newNodeId]);
        lastModifiedNodeId = newNodeId; // æ›´æ–°æœ€åä¿®æ”¹èŠ‚ç‚¹ID
        saveStateToUndo(lastModifiedNodeId);
      } else if (event.key === 'Tab') {
        // æ·»åŠ å­èŠ‚ç‚¹
        event.preventDefault();
        const newNodeId = getNextNodeId();
        addNodeWithAnimation(newNodeId, `æ–°èŠ‚ç‚¹${newNodeId}`, selectedNode);
        network.selectNodes([newNodeId]);
        lastModifiedNodeId = newNodeId; // æ›´æ–°æœ€åä¿®æ”¹èŠ‚ç‚¹ID
        saveStateToUndo(lastModifiedNodeId);
      } else if ((event.key === 'Backspace' || event.key === 'Delete')) {
        event.preventDefault();
        if (node.shape === 'image') {
          // ä»…ç§»é™¤å›¾ç‰‡ï¼Œä¿ç•™èŠ‚ç‚¹
          saveStateToUndo(selectedNode);
          nodes.update({
            id: selectedNode,
            shape: 'box',
            image: undefined // ç§»é™¤å›¾ç‰‡
          });
          lastModifiedNodeId = selectedNode; // æ›´æ–°æœ€åä¿®æ”¹èŠ‚ç‚¹ID
        } else {
          // ä¸å…è®¸åˆ é™¤æ ¹èŠ‚ç‚¹
          if (isRootNode) {
            alert("ä¸å…è®¸åˆ é™¤æ ¹èŠ‚ç‚¹ï¼");
            return;
          }
          // åˆ é™¤èŠ‚ç‚¹åŠå…¶åä»£
          saveStateToUndo(lastModifiedNodeId);
          const previousNodeId = getPreviousNodeId(selectedNode);
          deleteNodeAndDescendants(selectedNode);
          setTimeout(() => {
            applyCustomLayout();
            if (previousNodeId) {
              network.selectNodes([previousNodeId]);
              lastModifiedNodeId = previousNodeId; // æ›´æ–°æœ€åä¿®æ”¹èŠ‚ç‚¹ID
            } else {
              hideAnnotationPanel();
            }
          }, 100);
        }
      }
    } else {
      hideAnnotationPanel();
    }
  });

  // å‡½æ•°ï¼šæ·»åŠ æˆ–ç¼–è¾‘æ³¨é‡Š
  function addOrEditAnnotation() {
    const selectedNodes = network.getSelectedNodes();
    if (selectedNodes.length !== 1) {
      alert("è¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æ¥æ·»åŠ æˆ–ç¼–è¾‘æ³¨é‡Šï¼");
      return;
    }
    const nodeId = selectedNodes[0];
    const node = nodes.get(nodeId);
    if (!node) return;

    // åˆ›å»ºæ³¨é‡Šè¾“å…¥æ¡†
    isEditingNode = true;
    const position = network.getPositions([nodeId])[nodeId];
    if (!position) return; // é˜²æ­¢positionä¸ºnull
    const domPos = network.canvasToDOM(position);
    // åˆ›å»ºç¼–è¾‘è¾“å…¥æ¡†
    const input = document.createElement('textarea');
    input.placeholder = "è¯·è¾“å…¥æ³¨é‡Šå†…å®¹...";
    input.style.position = 'absolute';
    input.style.left = `${domPos.x - 140}px`;
    input.style.top = `${domPos.y - 35}px`;
    input.style.zIndex = 1001; /* é«˜äºæ“ä½œè¯´æ˜å®¹å™¨ */
    input.style.width = '280px';
    input.style.height = '70px';
    input.style.fontSize = '16px';
    input.style.fontFamily = 'Comic Neue, cursive';
    input.style.border = '3px solid #FF9933';
    input.style.borderRadius = '10px';
    input.style.padding = '10px';
    input.style.boxShadow = '0 0 15px rgba(0, 0, 0, 0.1)';
    input.style.backgroundColor = '#FFFACD';
    input.value = node.annotation || '';
    document.body.appendChild(input);
    input.focus();
    input.select();
    // å¤„ç†è¾“å…¥å˜åŒ–
    const handleInputChange = () => {
      const newAnnotation = input.value.trim();
      // æ›´æ–°èŠ‚ç‚¹çš„æ³¨é‡Šæ•°æ®
      saveStateToUndo(nodeId);
      nodes.update({
        id: nodeId,
        annotation: newAnnotation || undefined
      });
      lastModifiedNodeId = nodeId; // æ›´æ–°æœ€åä¿®æ”¹èŠ‚ç‚¹ID
      updateNodeLabel(nodes.get(nodeId));

      // å¦‚æœæ³¨é‡Šå†…å®¹ä¸ºç©ºï¼Œç§»é™¤æ³¨é‡Š
      if (!newAnnotation) {
        hideAnnotationPanel();
      } else {
        showAnnotationPanel(nodes.get(nodeId));
      }

      if (document.body.contains(input)) {
        document.body.removeChild(input);
      }
      isEditingNode = false;
    };
    // è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶
    input.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        handleInputChange();
      }
      event.stopPropagation();
    });
    // è¾“å…¥æ¡†å¤±ç„¦äº‹ä»¶
    input.addEventListener('blur', handleInputChange);
  }

  // åŒå‡»èŠ‚ç‚¹ç¼–è¾‘äº‹ä»¶
  network.on('doubleClick', function (params) {
    if (params.nodes.length === 1) {
      const nodeId = params.nodes[0];
      const node = nodes.get(nodeId);
      if (!node) return; // é˜²æ­¢nodeä¸ºnull
      saveStateToUndo(lastModifiedNodeId);
      isEditingNode = true;
      const position = network.getPositions([nodeId])[nodeId];
      if (!position) return; // é˜²æ­¢positionä¸ºnull
      const domPos = network.canvasToDOM(position);
      // åˆ›å»ºç¼–è¾‘è¾“å…¥æ¡†
      const input = document.createElement('textarea');
      // è·å–èŠ‚ç‚¹çš„åŸºç¡€æ–‡æœ¬å†…å®¹
      let baseLabel = node.baseLabel || '';
      input.value = baseLabel;
      input.style.position = 'absolute';
      input.style.left = `${domPos.x - 140}px`;
      input.style.top = `${domPos.y - 35}px`;
      input.style.zIndex = 1001; /* é«˜äºæ“ä½œè¯´æ˜å®¹å™¨ */
      input.style.width = '280px';
      input.style.height = '70px';
      input.style.fontSize = '22px';
      input.style.fontFamily = 'Comic Neue, cursive';
      input.style.border = '3px solid #FF9933';
      input.style.borderRadius = '10px';
      input.style.padding = '10px';
      input.style.boxShadow = '0 0 15px rgba(0, 0, 0, 0.1)';
      input.style.backgroundColor = '#FFFACD';
      document.body.appendChild(input);
      input.focus();
      input.select();
      // å¤„ç†è¾“å…¥å˜åŒ–
      const handleInputChange = () => {
        const newLabelText = input.value.trim();
        // æ›´æ–°èŠ‚ç‚¹çš„æ–‡æœ¬æ•°æ®
        nodes.update({
          id: nodeId,
          baseLabel: newLabelText,
          label: (node.annotation ? newLabelText + " ğŸ”–" : newLabelText)
        });
        lastModifiedNodeId = nodeId; // æ›´æ–°æœ€åä¿®æ”¹èŠ‚ç‚¹ID

        if (document.body.contains(input)) {
          document.body.removeChild(input);
        }
        isEditingNode = false;
      };
      // è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶
      input.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          handleInputChange();
        }
        event.stopPropagation();
      });
      // è¾“å…¥æ¡†å¤±ç„¦äº‹ä»¶
      input.addEventListener('blur', handleInputChange);
    }
  });

  // æ·»åŠ ç²˜è´´äº‹ä»¶ç›‘å¬
  document.addEventListener('paste', function (event) {
    if (isEditingNode) return; // ç¼–è¾‘æ¨¡å¼ä¸‹ä¸å¤„ç†
    const items = event.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
      if (items[i].type.indexOf("image") !== -1) {
        // æœ‰å›¾ç‰‡
        const blob = items[i].getAsFile();
        const reader = new FileReader();
        reader.onload = function (event) {
          const dataUrl = event.target.result;
          const selectedNodes = network.getSelectedNodes();
          if (selectedNodes.length === 1) {
            const nodeId = selectedNodes[0];
            saveStateToUndo(nodeId);
            // æ›´æ–°èŠ‚ç‚¹å½¢çŠ¶å’Œå›¾åƒ
            nodes.update({
              id: nodeId,
              shape: 'image',
              image: dataUrl,
              label: nodes.get(nodeId).baseLabel || '',
              size: 30 // åˆå§‹å¤§å°
            });
            // å¦‚æœèŠ‚ç‚¹æœ‰æ³¨é‡Šï¼Œä¿ç•™æ³¨é‡Šæ ‡è®°
            const currentNode = nodes.get(nodeId);
            if (currentNode.annotation) {
              nodes.update({
                id: nodeId,
                label: currentNode.baseLabel + " ğŸ”–"
              });
            }
            lastModifiedNodeId = nodeId; // æ›´æ–°æœ€åä¿®æ”¹èŠ‚ç‚¹ID
          }
        };
        reader.readAsDataURL(blob);
        event.preventDefault();
        return;
      }
    }
  });

  // æ˜¾ç¤ºResize Handle
  network.on('selectNode', function (params) {
    if (params.nodes.length === 1) {
      const nodeId = params.nodes[0];
      const node = nodes.get(nodeId);
      if (node && node.shape === 'image') {
        showResizeHandle(nodeId, node);
      } else {
        hideResizeHandle();
      }
      // æ˜¾ç¤ºæ³¨é‡Šé¢æ¿å¦‚æœèŠ‚ç‚¹æœ‰æ³¨é‡Š
      if (node && node.annotation) {
        showAnnotationPanel(node);
      } else {
        hideAnnotationPanel();
      }
    } else {
      hideResizeHandle();
      hideAnnotationPanel();
    }
  });

  // éšè—Resize Handle
  network.on('deselectNode', function (params) {
    hideResizeHandle();
    hideAnnotationPanel();
  });

  // æ˜¾ç¤ºResize Handleå‡½æ•°
  function showResizeHandle(nodeId, node) {
    if (!node) return; // é˜²æ­¢nodeä¸ºnull
    const positions = network.getPositions([nodeId]);
    const position = positions[nodeId];
    if (!position) return; // é˜²æ­¢positionä¸ºnull
    const domCoords = network.canvasToDOM(position);
    // è®¾ç½®Resize Handleçš„ä½ç½®ï¼Œä½äºèŠ‚ç‚¹çš„å³ä¸‹è§’
    resizeHandle.style.left = `${domCoords.x + getNodeWidth(node) - 7.5}px`;
    resizeHandle.style.top = `${domCoords.y + getNodeHeight(node) - 7.5}px`;
    resizeHandle.style.display = 'block';
  }

  // éšè—Resize Handleå‡½æ•°
  function hideResizeHandle() {
    resizeHandle.style.display = 'none';
    resizingNodeId = null;
  }

  // è·å–èŠ‚ç‚¹çš„å®½åº¦
  function getNodeWidth(node) {
    // æ ¹æ®èŠ‚ç‚¹å½¢çŠ¶å’Œå¤§å°è®¡ç®—å®½åº¦
    if (node.shape === 'image') {
      return node.size * 2; // ä¿®æ”¹ä¸º size * 2 ä»¥ç¬¦åˆvis-networkçš„sizeå®šä¹‰
    }
    return node.size * 2; // å¯¹äºå…¶ä»–å½¢çŠ¶ä¹Ÿä½¿ç”¨ size * 2
  }

  // è·å–èŠ‚ç‚¹çš„é«˜åº¦
  function getNodeHeight(node) {
    // æ ¹æ®èŠ‚ç‚¹å½¢çŠ¶å’Œå¤§å°è®¡ç®—é«˜åº¦
    if (node.shape === 'image') {
      return node.size * 2; // ä¿®æ”¹ä¸º size * 2 ä»¥ç¬¦åˆvis-networkçš„sizeå®šä¹‰
    }
    return node.size * 2; // å¯¹äºå…¶ä»–å½¢çŠ¶ä¹Ÿä½¿ç”¨ size * 2
  }

  // åˆå§‹ Resize ç›¸å…³å˜é‡
  var isResizing = false;
  var initialMouseX, initialMouseY;
  var initialSize;
  var resizingNodeId;

  // å®ç°Resize Handleæ‹–æ‹½åŠŸèƒ½
  resizeHandle.addEventListener('mousedown', function (event) {
    event.preventDefault();
    isResizing = true;
    initialMouseX = event.clientX;
    initialMouseY = event.clientY;
    const selectedNodes = network.getSelectedNodes();
    if (selectedNodes.length === 1) {
      resizingNodeId = selectedNodes[0];
      const node = nodes.get(resizingNodeId);
      if (node) {
        initialSize = node.size;
      }
    }
  });

  document.addEventListener('mousemove', function (event) {
    if (isResizing && resizingNodeId !== null) {
      const deltaX = event.clientX - initialMouseX;
      const deltaY = event.clientY - initialMouseY;
      const delta = Math.max(deltaX, deltaY);
      const newSize = Math.max(10, initialSize + delta / 2); // æé«˜çµæ•åº¦ï¼Œä» /5 æ”¹ä¸º /2
      const node = nodes.get(resizingNodeId);
      if (node) {
        nodes.update({
          id: resizingNodeId,
          size: newSize
        });
        // å®æ—¶æ›´æ–°Resize Handleä½ç½®
        const positions = network.getPositions([resizingNodeId]);
        const position = positions[resizingNodeId];
        if (position) {
          const domCoords = network.canvasToDOM(position);
          resizeHandle.style.left = `${domCoords.x + getNodeWidth(node) - 7.5}px`;
          resizeHandle.style.top = `${domCoords.y + getNodeHeight(node) - 7.5}px`;
        }
      }
    }
  });

  document.addEventListener('mouseup', function (event) {
    if (isResizing && resizingNodeId !== null) {
      isResizing = false;
      saveStateToUndo(resizingNodeId);
      applyCustomLayout();
      resizingNodeId = null;
    }
  });

  // æ›´æ–°Resize Handleçš„ä½ç½®åœ¨æ¯æ¬¡æ¸²æŸ“å
  network.on('afterDrawing', function () {
    const selectedNodes = network.getSelectedNodes();
    if (selectedNodes.length === 1) {
      const nodeId = selectedNodes[0];
      const node = nodes.get(nodeId);
      if (node && node.shape === 'image') {
        const positions = network.getPositions([nodeId]);
        const position = positions[nodeId];
        if (position) {
          const domCoords = network.canvasToDOM(position);
          resizeHandle.style.left = `${domCoords.x + getNodeWidth(node) - 7.5}px`;
          resizeHandle.style.top = `${domCoords.y + getNodeHeight(node) - 7.5}px`;
        }
      }
    }
  });

  // èŠ‚ç‚¹æ‹–åŠ¨å¼€å§‹äº‹ä»¶
  network.on("dragStart", function (params) {
    if (params.nodes.length === 1) {
      network.setOptions({ physics: false });
    }
    hideResizeHandle();
    hideAnnotationPanel();
  });

  // èŠ‚ç‚¹æ‹–åŠ¨ç»“æŸäº‹ä»¶
  network.on("dragEnd", function (params) {
    if (params.nodes.length === 1) {
      saveStateToUndo(lastModifiedNodeId);
      applyCustomLayout();
    }
  });

  // èŠ‚ç‚¹å˜åŒ–äº‹ä»¶
  nodes.on(['add', 'remove', 'update'], function (event, properties, senderId) {
    if (!isExecutingUndoRedo) {
      // åœ¨èŠ‚ç‚¹å˜åŒ–åç«‹å³åº”ç”¨å¸ƒå±€
      applyCustomLayout();
    }
  });

  // è¾¹å˜åŒ–äº‹ä»¶
  edges.on(['add', 'remove', 'update'], function (event, properties, senderId) {
    if (!isExecutingUndoRedo) {
      // åœ¨è¾¹å˜åŒ–åç«‹å³åº”ç”¨å¸ƒå±€
      applyCustomLayout();
    }
  });

  // å‡½æ•°ï¼šè·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ID
  function getNextNodeId() {
    const existingIds = nodes.getIds();
    return Math.max(...existingIds) + 1;
  }

  // å‡½æ•°ï¼šåº”ç”¨è‡ªå®šä¹‰å¸ƒå±€
  function applyCustomLayout() {
    if (isExecutingUndoRedo) {
      // é¿å…åœ¨æ’¤é”€/é‡åšæ—¶é‡æ–°åº”ç”¨å¸ƒå±€
      return;
    }
    const tree = buildTree();
    const roots = findRoots(tree);
    const nodeSeparation = 150;
    const levelSeparation = 220;
    const startX = 50;
    const startY = container.clientHeight / 2;
    let currentY = startY;
    roots.forEach(root => {
      currentY = layoutNode(root, 0, startX, currentY, nodeSeparation, levelSeparation);
    });
    nodes.forEach(node => {
      if (tree[node.id]) { // ç¡®ä¿treeä¸­æœ‰è¯¥èŠ‚ç‚¹çš„æ•°æ®
        nodes.update({
          id: node.id,
          x: tree[node.id].x,
          y: tree[node.id].y,
          fixed: { x: true, y: true } // å›ºå®šèŠ‚ç‚¹ä½ç½®
        });
      }
    });
    network.fit({
      animation: {
        duration: 1000,
        easingFunction: 'easeInOutQuad'
      }
    });
  }

  // å‡½æ•°ï¼šæ„å»ºæ ‘ç»“æ„
  function buildTree() {
    const tree = {};
    nodes.forEach(node => {
      tree[node.id] = { ...node, children: [] };
    });
    edges.forEach(edge => {
      if (tree[edge.from] && tree[edge.to]) {
        tree[edge.from].children.push(tree[edge.to]);
      }
    });
    return tree;
  }

  // å‡½æ•°ï¼šæŸ¥æ‰¾æ ¹èŠ‚ç‚¹
  function findRoots(tree) {
    return Object.values(tree).filter(node => !edges.get().some(edge => edge.to === node.id));
  }

  // å‡½æ•°ï¼šå¸ƒå±€èŠ‚ç‚¹
  function layoutNode(node, depth, xOffset, yOffset, nodeSeparation, levelSeparation) {
    node.x = xOffset + depth * levelSeparation;
    let numChildren = node.children.length;
    if (numChildren === 0) {
      node.y = yOffset;
      return yOffset + nodeSeparation;
    }
    let currentY = yOffset - (numChildren - 1) * nodeSeparation / 2;
    node.children.forEach(child => {
      currentY = layoutNode(child, depth + 1, xOffset, currentY, nodeSeparation, levelSeparation);
    });
    const firstChild = node.children[0];
    const lastChild = node.children[node.children.length - 1];
    node.y = (firstChild.y + lastChild.y) / 2;
    return currentY;
  }

  // å‡½æ•°ï¼šåˆ é™¤èŠ‚ç‚¹åŠå…¶åä»£
  function deleteNodeAndDescendants(nodeId) {
    const descendants = getDescendants(nodeId);
    nodes.remove([nodeId, ...descendants]);
    edges.remove(edges.get().filter(edge => edge.from === nodeId || edge.to === nodeId || descendants.includes(edge.from) || descendants.includes(edge.to)));
  }

  // å‡½æ•°ï¼šè·å–èŠ‚ç‚¹çš„åä»£
  function getDescendants(nodeId) {
    const descendants = [];
    const childEdges = edges.get().filter(edge => edge.from === nodeId);
    childEdges.forEach(edge => {
      descendants.push(edge.to);
      descendants.push(...getDescendants(edge.to));
    });
    return descendants;
  }

  // å‡½æ•°ï¼šæ·»åŠ å¸¦åŠ¨ç”»çš„æ–°èŠ‚ç‚¹
  function addNodeWithAnimation(newNodeId, label, parentNodeId) {
    const parentNode = nodes.get(parentNodeId);
    const parentPos = parentNode ? network.getPositions([parentNodeId])[parentNodeId] : null;
    const initialX = parentPos ? parentPos.x + 50 : 50;
    const initialY = parentPos ? parentPos.y : container.clientHeight / 2;
    nodes.add({
      id: newNodeId,
      label: label,
      baseLabel: label,
      shape: 'box',
      x: initialX,
      y: initialY,
      fixed: { x: false, y: false },
      color: { background: '#FFFACD', border: '#FF9933' },
      font: { color: '#000000' },
      size: 30,
      className: 'new-node' // æ·»åŠ åŠ¨ç”»ç±»
    });
    edges.add({
      from: parentNodeId,
      to: newNodeId
    });
    // åº”ç”¨å¸ƒå±€
    applyCustomLayout();
    // åœ¨åŠ¨ç”»ç»“æŸåç§»é™¤ç±»
    setTimeout(() => {
      nodes.update({
        id: newNodeId,
        className: ''
      });
    }, 650); // ä¸CSSåŠ¨ç”»æŒç»­æ—¶é—´åŒ¹é…
  }

  // å‡½æ•°ï¼šè·å–å‰ä¸€ä¸ªèŠ‚ç‚¹ID
  function getPreviousNodeId(currentNodeId) {
    const allNodes = nodes.get({
      returnType: "object",
      fields: ['id']
    });
    const allNodeArray = Object.values(allNodes);
    const currentIndex = allNodeArray.findIndex(node => node.id === currentNodeId);
    if (currentIndex > 0) {
      return allNodeArray[currentIndex - 1].id;
    }
    return null;
  }

  // åˆå§‹åº”ç”¨å¸ƒå±€
  applyCustomLayout();

  // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°åº”ç”¨å¸ƒå±€
  window.addEventListener('resize', applyCustomLayout);

  // æ˜¾ç¤ºæ³¨é‡Šé¢æ¿
  function showAnnotationPanel(node) {
    annotationContent.textContent = node.annotation;
    annotationContainer.style.display = 'block';
  }

  // éšè—æ³¨é‡Šé¢æ¿
  function hideAnnotationPanel() {
    annotationContainer.style.display = 'none';
    annotationContent.textContent = '';
  }

  // å‡½æ•°ï¼šæ›´æ–°èŠ‚ç‚¹æ ‡ç­¾ä»¥æ˜¾ç¤º/ç§»é™¤æ³¨é‡Šæ ‡è®°
  function updateNodeLabel(node) {
    if (node.annotation) {
      if (!node.label.endsWith(" ğŸ”–")) {
        nodes.update({
          id: node.id,
          label: node.baseLabel + " ğŸ”–"
        });
      }
    } else {
      nodes.update({
        id: node.id,
        label: node.baseLabel
      });
    }
  }

  // åˆå§‹åº”ç”¨å¸ƒå±€
  applyCustomLayout();

  // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°åº”ç”¨å¸ƒå±€
  window.addEventListener('resize', applyCustomLayout);
</script>

<!-- å¼•å…¥ UndoRedo è„šæœ¬ -->
<script src="undoRedo.js"></script>
</body>

</html>